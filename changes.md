# changes

## 控制面数据面数据同步问题

**问题**

由于同步顺序原因，再sidecar 再接收到请求后才会判断是否需要获取新的 eds（根据cds判断）或 rds（根据lds）判断。如果需要重新获取才则重新发起请求。这样中间可能有一段时间，出现lds中有router，但是rds中没有的情况。或者有cds 但是没有eds 的情况。这时envoy 接收到请求就会出错。

**解决方案**

修改方式为再推送 lds和 cds 的同时，更新服务端监听的rds和eds 数据。根据新的数据重新推送数据到sidecar。



## IP栈判断不准确

**问题**

 istio 代码中判断是否为ipv6 的方式为 遍历ip，存在一个ipv4 就认为是ipv4 环境。

**解决方式**

遍历所有ip，存在任意一个ip为 v6 版本，就认为ipv6 可用。



## 双栈时非默认栈流量被抛弃

**问题**

入向流量，在双栈ipv6场景下， 使用ipv4流量发送请求时，由于没有配置ipv4 的passthrough，所以ipv4 的流量会被丢弃。

**解决方式**

在双栈时，同时添加 ipv4的passthrough和 ipv6 的passthrough

## 双栈时如果只注册一个栈另一个栈不可访问

**问题**

envoy 中根据域名获取IP时，分为了获取ipv6 地址和获取ipv4 地址，默认情况下，如果没有配置 ipv4 兼容，那么envoy 只会获取ipv4的地址。

在双栈时，如果应用只注册了 ipv6 地址，没有注册ipv4 地址， 这时候，envoy 只会去取ipv4 的地址，不会去取ipv6 的地址。由于没有注册ipv6 地址，所以此时域名将无法访问。

**解决方式**

在envoy 的listener 配置中添加 ipv4 兼容模式

## Consul 数据中获取服务命名空间处理

**问题**

从consul 中获取的数据，默认没有命名空间，在istio中统一的都设置为default ，不能满足规则设置的要求。

**修改**

在服务的label中添加命名空间属性，通过解析label 设置服务对应的命名空间





